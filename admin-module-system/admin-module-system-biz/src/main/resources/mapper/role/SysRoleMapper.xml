<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.admin.module.system.biz.dal.mapper.SysRoleMapper">

    <!-- 基础结果映射 -->
    <resultMap id="BaseResultMap" type="com.admin.module.system.biz.dal.dataobject.SysRoleDO">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="role_name" property="roleName" jdbcType="VARCHAR"/>
        <result column="role_code" property="roleCode" jdbcType="VARCHAR"/>
        <result column="role_desc" property="roleDesc" jdbcType="VARCHAR"/>
        <result column="sort_order" property="sortOrder" jdbcType="INTEGER"/>
        <result column="status" property="status" jdbcType="TINYINT"/>
        <result column="remark" property="remark" jdbcType="VARCHAR"/>
        <result column="create_by" property="createBy" jdbcType="VARCHAR"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_by" property="updateBy" jdbcType="VARCHAR"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="version" property="version" jdbcType="INTEGER"/>
        <result column="deleted" property="deleted" jdbcType="TINYINT"/>
    </resultMap>

    <!-- 基础字段列表 -->
    <sql id="Base_Column_List">
        id, role_name, role_code, role_desc, sort_order, status, remark,
        create_by, create_time, update_by, update_time, version, deleted
    </sql>

    <!-- 根据角色名称查询角色 -->
    <select id="selectByRoleName" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_role
        WHERE role_name = #{roleName,jdbcType=VARCHAR}
          AND deleted = 0
        LIMIT 1
    </select>

    <!-- 根据角色编码查询角色 -->
    <select id="selectByRoleCode" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_role
        WHERE role_code = #{roleCode,jdbcType=VARCHAR}
          AND deleted = 0
        LIMIT 1
    </select>

    <!-- 根据用户ID查询角色列表 -->
    <select id="selectRolesByUserId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT
        r.id, r.role_name, r.role_code, r.role_desc, r.sort_order, r.status, r.remark,
        r.create_by, r.create_time, r.update_by, r.update_time, r.version, r.deleted
        FROM sys_role r
        INNER JOIN sys_user_role ur ON r.id = ur.role_id
        WHERE ur.user_id = #{userId,jdbcType=BIGINT}
          AND r.deleted = 0
          AND r.status = 1
        ORDER BY r.sort_order ASC, r.create_time DESC
    </select>

    <!-- 查询角色是否被用户使用 -->
    <select id="countRoleUsageByUsers" parameterType="java.lang.Long" resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM sys_user_role
        WHERE role_id = #{roleId,jdbcType=BIGINT}
    </select>

    <!-- 根据角色ID列表查询角色信息 -->
    <select id="selectRolesByIds" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_role
        WHERE id IN
        <foreach collection="roleIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND deleted = 0
        ORDER BY sort_order ASC, create_time DESC
    </select>

    <!-- 查询所有启用状态的角色 -->
    <select id="selectEnabledRoles" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_role
        WHERE status = 1
          AND deleted = 0
        ORDER BY sort_order ASC, create_time DESC
    </select>

    <!-- 根据条件分页查询角色 -->
    <select id="selectRolePageByCondition" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_role
        WHERE deleted = 0
        <if test="roleName != null and roleName != ''">
            AND role_name LIKE CONCAT('%', #{roleName}, '%')
        </if>
        <if test="roleCode != null and roleCode != ''">
            AND role_code LIKE CONCAT('%', #{roleCode}, '%')
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY sort_order ASC, create_time DESC
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.admin.module.notification.biz.dal.mapper.SystemAnnouncementMapper">

    <!-- 分页查询系统公告 -->
    <select id="selectSystemAnnouncementPage" resultType="com.admin.module.notification.biz.dal.dataobject.SystemAnnouncementDO">
        SELECT * FROM system_announcement
        WHERE deleted = 0
        <if test="pageDTO.title != null and pageDTO.title != ''">
            AND title LIKE CONCAT('%', #{pageDTO.title}, '%')
        </if>
        <if test="pageDTO.type != null">
            AND type = #{pageDTO.type}
        </if>
        <if test="pageDTO.status != null">
            AND status = #{pageDTO.status}
        </if>
        <if test="pageDTO.priority != null">
            AND priority = #{pageDTO.priority}
        </if>
        <if test="pageDTO.isTop != null">
            AND is_top = #{pageDTO.isTop}
        </if>
        <if test="pageDTO.isPopup != null">
            AND is_popup = #{pageDTO.isPopup}
        </if>
        <if test="pageDTO.createTime != null and pageDTO.createTime.size() == 2">
            AND create_time BETWEEN #{pageDTO.createTime[0]} AND #{pageDTO.createTime[1]}
        </if>
        <if test="pageDTO.publishTime != null and pageDTO.publishTime.size() == 2">
            AND publish_time BETWEEN #{pageDTO.publishTime[0]} AND #{pageDTO.publishTime[1]}
        </if>
        ORDER BY is_top DESC, priority DESC, create_time DESC
    </select>

    <!-- 查询有效的系统公告列表 -->
    <select id="selectEffectiveAnnouncements" resultType="com.admin.module.notification.biz.dal.dataobject.SystemAnnouncementDO">
        SELECT * FROM system_announcement
        WHERE deleted = 0
        AND status = #{status}
        AND (effective_time IS NULL OR effective_time &lt;= #{currentTime})
        AND (expire_time IS NULL OR expire_time &gt; #{currentTime})
        ORDER BY is_top DESC, priority DESC, publish_time DESC
    </select>

    <!-- 查询置顶公告列表 -->
    <select id="selectTopAnnouncements" resultType="com.admin.module.notification.biz.dal.dataobject.SystemAnnouncementDO">
        SELECT * FROM system_announcement
        WHERE deleted = 0
        AND status = #{status}
        AND is_top = #{isTop}
        AND (effective_time IS NULL OR effective_time &lt;= #{currentTime})
        AND (expire_time IS NULL OR expire_time &gt; #{currentTime})
        ORDER BY priority DESC, publish_time DESC
    </select>

    <!-- 查询弹窗公告列表 -->
    <select id="selectPopupAnnouncements" resultType="com.admin.module.notification.biz.dal.dataobject.SystemAnnouncementDO">
        SELECT * FROM system_announcement
        WHERE deleted = 0
        AND status = #{status}
        AND is_popup = #{isPopup}
        AND (effective_time IS NULL OR effective_time &lt;= #{currentTime})
        AND (expire_time IS NULL OR expire_time &gt; #{currentTime})
        ORDER BY priority DESC, publish_time DESC
    </select>

    <!-- 根据类型查询公告列表 -->
    <select id="selectAnnouncementsByType" resultType="com.admin.module.notification.biz.dal.dataobject.SystemAnnouncementDO">
        SELECT * FROM system_announcement
        WHERE deleted = 0
        AND type = #{type}
        AND status = #{status}
        AND (effective_time IS NULL OR effective_time &lt;= #{currentTime})
        AND (expire_time IS NULL OR expire_time &gt; #{currentTime})
        ORDER BY is_top DESC, priority DESC, publish_time DESC
    </select>

    <!-- 统计各状态公告数量 -->
    <select id="countByStatus" resultType="java.lang.Long">
        SELECT COUNT(*) FROM system_announcement
        WHERE deleted = 0
        AND status = #{status}
    </select>

    <!-- 统计各类型公告数量 -->
    <select id="countByTypeAndStatus" resultType="java.lang.Long">
        SELECT COUNT(*) FROM system_announcement
        WHERE deleted = 0
        AND type = #{type}
        AND status = #{status}
    </select>

    <!-- 批量更新公告状态 -->
    <update id="batchUpdateStatus">
        UPDATE system_announcement
        SET status = #{status}, updater = #{updater}, update_time = NOW()
        WHERE deleted = 0
        AND id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 批量更新公告置顶状态 -->
    <update id="batchUpdateTopStatus">
        UPDATE system_announcement
        SET is_top = #{isTop}, updater = #{updater}, update_time = NOW()
        WHERE deleted = 0
        AND id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 增加阅读次数 -->
    <update id="incrementReadCount">
        UPDATE system_announcement
        SET read_count = read_count + 1, update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 查询即将过期的公告 -->
    <select id="selectExpiringAnnouncements" resultType="com.admin.module.notification.biz.dal.dataobject.SystemAnnouncementDO">
        SELECT * FROM system_announcement
        WHERE deleted = 0
        AND status = #{status}
        AND expire_time IS NOT NULL
        AND expire_time &lt;= #{beforeTime}
        AND expire_time &gt; NOW()
    </select>

    <!-- 查询已过期的公告 -->
    <select id="selectExpiredAnnouncements" resultType="com.admin.module.notification.biz.dal.dataobject.SystemAnnouncementDO">
        SELECT * FROM system_announcement
        WHERE deleted = 0
        AND status = #{status}
        AND expire_time IS NOT NULL
        AND expire_time &lt; #{currentTime}
    </select>

    <!-- 批量更新公告状态 -->
    <update id="batchUpdateStatus">
        UPDATE system_announcement 
        SET status = #{status}, updater = #{updater}, update_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND deleted = 0
    </update>

    <!-- 批量更新公告置顶状态 -->
    <update id="batchUpdateTopStatus">
        UPDATE system_announcement 
        SET is_top = #{isTop}, updater = #{updater}, update_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND deleted = 0
    </update>

</mapper>
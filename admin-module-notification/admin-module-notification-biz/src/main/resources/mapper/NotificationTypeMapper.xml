<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.admin.module.notification.biz.dal.mapper.NotificationTypeMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.admin.module.notification.biz.dal.dataobject.NotificationTypeDO">
        <id column="id" property="id" />
        <result column="name" property="name" />
        <result column="code" property="code" />
        <result column="description" property="description" />
        <result column="icon" property="icon" />
        <result column="color" property="color" />
        <result column="sort" property="sort" />
        <result column="status" property="status" />
        <result column="is_system" property="isSystem" />
        <result column="creator" property="creator" />
        <result column="create_time" property="createTime" />
        <result column="updater" property="updater" />
        <result column="update_time" property="updateTime" />
        <result column="deleted" property="deleted" />
        <result column="tenant_id" property="tenantId" />
        <result column="remark" property="remark" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, name, code, description, icon, color, sort, status, is_system,
        creator, create_time, updater, update_time, deleted, tenant_id, remark
    </sql>

    <!-- 分页查询通知类型列表 -->
    <select id="selectNotificationTypePage" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM notification_type
        <where>
            deleted = 0
            <if test="query.name != null and query.name != ''">
                AND name LIKE CONCAT('%', #{query.name}, '%')
            </if>
            <if test="query.code != null and query.code != ''">
                AND code LIKE CONCAT('%', #{query.code}, '%')
            </if>
            <if test="query.status != null">
                AND status = #{query.status}
            </if>
            <if test="query.isSystem != null">
                AND is_system = #{query.isSystem}
            </if>
            <if test="query.createTime != null and query.createTime.size() == 2">
                AND create_time &gt;= #{query.createTime[0]}
                AND create_time &lt;= #{query.createTime[1]}
            </if>
        </where>
        ORDER BY sort ASC, create_time DESC
    </select>

    <!-- 查询通知类型列表 -->
    <select id="selectNotificationTypeList" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM notification_type
        <where>
            deleted = 0
            <if test="query.name != null and query.name != ''">
                AND name LIKE CONCAT('%', #{query.name}, '%')
            </if>
            <if test="query.code != null and query.code != ''">
                AND code LIKE CONCAT('%', #{query.code}, '%')
            </if>
            <if test="query.status != null">
                AND status = #{query.status}
            </if>
            <if test="query.isSystem != null">
                AND is_system = #{query.isSystem}
            </if>
        </where>
        ORDER BY sort ASC, create_time DESC
    </select>

    <!-- 根据状态查询通知类型列表 -->
    <select id="selectByStatus" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM notification_type
        WHERE deleted = 0 AND status = #{status}
        ORDER BY sort ASC, create_time DESC
    </select>

    <!-- 根据编码查询通知类型 -->
    <select id="selectByCode" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM notification_type
        WHERE deleted = 0 AND code = #{code}
        LIMIT 1
    </select>

    <!-- 检查类型编码是否唯一 -->
    <select id="checkCodeUnique" resultType="java.lang.Boolean">
        SELECT COUNT(1) = 0
        FROM notification_type
        WHERE deleted = 0 
            AND code = #{code}
            <if test="excludeId != null">
                AND id != #{excludeId}
            </if>
    </select>

    <!-- 检查类型名称是否唯一 -->
    <select id="checkNameUnique" resultType="java.lang.Boolean">
        SELECT COUNT(1) = 0
        FROM notification_type
        WHERE deleted = 0 
            AND name = #{name}
            <if test="excludeId != null">
                AND id != #{excludeId}
            </if>
    </select>

    <!-- 获取最大排序值 -->
    <select id="selectMaxSort" resultType="java.lang.Integer">
        SELECT IFNULL(MAX(sort), 0)
        FROM notification_type
        WHERE deleted = 0
    </select>

    <!-- 批量更新状态 -->
    <update id="updateStatusBatch">
        UPDATE notification_type
        SET status = #{status}, updater = #{updater}, update_time = NOW()
        WHERE deleted = 0 AND id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

</mapper>